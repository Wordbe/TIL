# RabbitMQ 003



# 6 Exchange Routing 을 통한 메시지 패턴

- RabbitMQ 의 큰 강점은 발행자 애플리케이션이 제공한 라우팅 정보를 기반으로 메시지를 서로 다른 큐로 유연하게 라우팅할 수 있다는 점이다



## 1 Direct Exchange

- **라우팅 키의 값에 따라 연결된 큐에 라우팅하며 문자열 일치 매칭만 수행한다.**
- 메시지 발생시 사용하는 라우팅 키와 동일한 키로 익스체인지에 바인딩된 모든 큐에 메시지가 전달된다.
- RabbitMQ 는 다이렉트 익스체인지 바인딩의 라우팅키를 평가할 때 문자열이 동일한지만 평가한다.
- 익스체인지 선언
- RPC 작업자 생성
- RPC 발행자 코드 작성

## 2 Fanout Exchange 를 사용한 메시지 브로드캐스팅

- **메시지에 설정한 라우팅 키에 관계없이 연결된 모든 큐에 전달한다.**
- 발행된 모든 메시지는 팬아웃 익스체인지에 연결된 모든 큐에 전달된다.
- `exchange_type=fanout`



## 3 Topic Exchange 로 메세지를 선택적으로 라우팅하기

- **라우팅 키 패턴 매칭 및 문자열 동일 비교를 사용해 모든 연결된 큐에 전달한다.**
- 라우팅 키에 기간 구분형식의 와일드카드 기반 패턴 매칭을 사용해서 큐에 바인딩할 수 있다.
- {메시지 최상위 분류}.{애플리케이션의 메시지 유형}.{메시지의 추가적인 데이터분류 형식}
  - image.new.profile

## 4 Header Exchange 로 선택적 라우팅

- 메시지 속성 headers 테이블의 값을 기반으로 메시지를 연결된 큐에 전달한다.
- 추가적 계산 때문에 다른 익스체인지보다 상당히 느리다고 알려져 있다.

## 5 익스체인지 성능 벤치마크하기



## 6 익스체인지 간 라우팅하기

- AMQP 스펙엔 없지만 RabbitMQ 에는 익스체인지 조합으로 메시지를 라우팅할 수 있다.
- 큐 바인딩과 유사. 큐를 익스체인지에 연결하는 대신 Exchange.Bind RPC 메소드로 익스체인지를 다른 익스체인지를 연결한다.

## 7 Consistent Hashing Exchange

- 팬아웃 익스체인지와 유사하지만, 라우팅 키 또는 메시지 속성 헤더 값의 해시 값을 기반으로 메시지를 분배한다.
- RabbitMQ 가 배포하는 플러그인
- 연결된 큐에 메시지를 분배한다.
- 메시지를 발행할 큐의 로드를 조정하는 데 사용한다.
- 클러스터 내부에 다른 물리적 서버에 있는 큐 혹은 단일 사용자가 연결된 큐에 메시지를 분배할 수 있다. 단일 큐를 사용하는 여러 사용자에게 메세지를 전달하는 경우보다 처리량이 높다.
- consistent hashing exchange 로 미들웨이를 직접 작성하지 안호도 데이터를 샤딩할 수 있다.
- memcached 혹은 Riak, Cassandra, PostgreSQL(PL/Proxy 사용시)과 같은 분산 데이터베이스 시스템에서 사용된다.