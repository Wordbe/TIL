# RabbitMQ 003



# 6 Exchange Routing 을 통한 메시지 패턴

- RabbitMQ 의 큰 강점은 발행자 애플리케이션이 제공한 라우팅 정보를 기반으로 메시지를 서로 다른 큐로 유연하게 라우팅할 수 있다는 점이다



## 1 Direct Exchange

- **라우팅 키의 값에 따라 연결된 큐에 라우팅하며 문자열 일치 매칭만 수행한다.**
- 메시지 발생시 사용하는 라우팅 키와 동일한 키로 익스체인지에 바인딩된 모든 큐에 메시지가 전달된다.
- RabbitMQ 는 다이렉트 익스체인지 바인딩의 라우팅키를 평가할 때 문자열이 동일한지만 평가한다.
- 익스체인지 선언
- RPC 작업자 생성
- RPC 발행자 코드 작성

## 2 Fanout Exchange 를 사용한 메시지 브로드캐스팅

- **메시지에 설정한 라우팅 키에 관계없이 연결된 모든 큐에 전달한다.**
- 발행된 모든 메시지는 팬아웃 익스체인지에 연결된 모든 큐에 전달된다.
- `exchange_type=fanout`



## 3 Topic Exchange 로 메세지를 선택적으로 라우팅하기

- **라우팅 키 패턴 매칭 및 문자열 동일 비교를 사용해 모든 연결된 큐에 전달한다.**
- 라우팅 키에 기간 구분형식의 와일드카드 기반 패턴 매칭을 사용해서 큐에 바인딩할 수 있다.
- {메시지 최상위 분류}.{애플리케이션의 메시지 유형}.{메시지의 추가적인 데이터분류 형식}
  - image.new.profile

## 4 Header Exchange 로 선택적 라우팅

- 메시지 속성 headers 테이블의 값을 기반으로 메시지를 연결된 큐에 전달한다.
- 추가적 계산 때문에 다른 익스체인지보다 상당히 느리다고 알려져 있다.

## 5 익스체인지 성능 벤치마크하기



## 6 익스체인지 간 라우팅하기

- AMQP 스펙엔 없지만 RabbitMQ 에는 익스체인지 조합으로 메시지를 라우팅할 수 있다.
- 큐 바인딩과 유사. 큐를 익스체인지에 연결하는 대신 Exchange.Bind RPC 메소드로 익스체인지를 다른 익스체인지를 연결한다.

## 7 Consistent Hashing Exchange

- 팬아웃 익스체인지와 유사하지만, 라우팅 키 또는 메시지 속성 헤더 값의 해시 값을 기반으로 메시지를 분배한다.
- RabbitMQ 가 배포하는 플러그인
- 연결된 큐에 메시지를 분배한다.
- 메시지를 발행할 큐의 로드를 조정하는 데 사용한다.
- 클러스터 내부에 다른 물리적 서버에 있는 큐 혹은 단일 사용자가 연결된 큐에 메시지를 분배할 수 있다. 단일 큐를 사용하는 여러 사용자에게 메세지를 전달하는 경우보다 처리량이 높다.
- consistent hashing exchange 로 미들웨이를 직접 작성하지 안호도 데이터를 샤딩할 수 있다.
- memcached 혹은 Riak, Cassandra, PostgreSQL(PL/Proxy 사용시)과 같은 분산 데이터베이스 시스템에서 사용된다.



---

# 2부 데이터 센터 또는 클라우드에서 RabbitMQ 운영하기



# 7 클러스터를 이용한 RabbitMQ 확장

- 메시지 브로커인 RabbitMQ 는 독립적으로 실행가능한 애플리케이션이다.

## 1 클러스터

- RabbitMQ 클러스터는 둘 이상 서버를 하나의 RabbitMQ 처럼 사용할 수 있도록 한다.
- 익스체인지, 큐, 바인딩, 사용자, 가상 호스트, 정책 등 런타임 상태의 모든 노드에서 사용할 수 있다.

### 1 클러스터 및 관리자 UI

- RabbitMQ 관리자 UI 는 모든 작업들이 클러스터에서도 단일 노드와 동일하게 수행되도록 디자인 돼있다.

### 2 클러스터 노드 유형

- 디스크 노드
  - 클러스터의 런타임 상태를 RAM 과 디스크에 저장한다.
  - 디스크 노드와 연결된 통계 노드 : 통계 및 상태 데이터 수집한다. 
  - 기본 디스크 노드, 보조 디스크 노드로 사용 가능
- RAM 노드
  - 런타임 상태 정보를 메모리 데이터베이스에만 저장한다.
  - 관리자 기능이 없다.

### 3 클러스터 및 큐 동작

- Queue.Declare RPC 요청이 전송된 클러스터 노드에 큐가 생성된다.
- 발행자 고려하기
  - (빠름) 보장 없음 / 실패 통보 / 발행자 확인 / 대체 익스체인지 / HA 큐 / 트랜잭션 / 트랜잭션 HA 큐 (느림)
  - 오른쪽으로 갈수록 클러스터의 노드 간 통신량이 증가한다.
- 노드 특정 소비자
  - 소비자를 큐가 있는 노드에 연결하면 메시지 처리량이 향상된다.



## 2 클러스터 설정

- RabbitMQ 클러스터는 두 개 이상의 노드가 필요하다.

### 1 가상 머신 설정

### 2 클러스터에 노드 추가

- rabbitmq.config 환경 파일 편집

- 또는 rabbitmqctl 명령을 사용해 클러스터에 노드를 추가하거나 제거

- 얼랭 쿠키 : 다중 노드 통신의 보안을 위한 비밀 공유 파일 (`/var/lib/rabbitmq/.erlang.cookie`)

- 수동으로 클러스터 생성하기

  ```shell
  rabbitmqctl stop_app
  rabbitmqctl reset
  rabbitmqctl join_cluster rabbit@primary
  rabbitmqctl start_app
  
  # http://localhost:15672 관리자 UI 에 접속하면 두 개의 노드가 실행 중인 RabbitMQ 클러스터가 구성됐다.
  ```

- 환경 파일 기반 클러스터

  /etc/rabbitmq.config

  ```shell
  [{rabbit,
  	[{cluster_nodes, {['rabbit@primary', 'rabbit@secondary'], disc}}]
  }],
  
  # 혹은 ram 노드로 바꾸려면 disc 대신 ram 으로 수정
  ```

  