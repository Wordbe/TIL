# Unit Testing 005 - 목과 테스트 취약성





# 1 Mock 과 Stub 의 구분

- 목은 SUT(테스트 대상 시스템)과 협력자 사이 상호 작용을 검사할 수 있는 테스트 대역이다.



## 1 테스트 대역 종류

- **stub**
  - 내부로 들어오는 상호 작용 모방
  - SUT 가 입력 데이터를 얻기 위해 의존성을 호출
  - 시나리오마다 다른 값을 반환하게 구성할 수 있는 완전한 의존성
  - dummy
    - 단순하고 하드 코딩 된 값
  - fake
    - 아직 존재하지 않는 의존성을 대체
- **mock**
  - 외부로 나가는 상호 작용 모방하고 검사
  - SUT 가 상태를 바꾸기 위해 의존성을 호출
  - 목 프레임워크 도움 받아 생성
  - spy
    - 수동으로 작성
    - 직접 작성한 목



## 2 도구로서 목 | 테스트 대역으로서 목

- Mock(도구 라이브러리)은 목(테스트 대역)이나 스텁을 만드는 데 사용할 수 있는 목 라이브러리 클래스이다.





## 3 스텁으로 상호 작용을 검증하지 말라

- stub 은 SUT 가 출력을 생성하도록 입력을 제공한다.
- assert 를 써라.

```C#
var stub = new Mock<IDatabase>();
stub.Setup(x => x.GetNumberOfUsers()).Returns(10);

var sut = new Controller(stub.Object);

Report report = sut.CreateReport();

Assert.Equal(10, report.NumberOfUsers);
stub.Verify(x => x.GetNumberOfUsers()), Times.Once); // stub 으로 상호작용 검사하지 말자.
```

- 최종 결과가 아닌 사항을 검증하는 것을 과잉 명세 (overspecification) 라고 한다.



## 4 목과 스텁 함께 쓰기



## 5 목과 스텁은 명령 조회 분리 원칙과 관련있다.

- 명령 : 부작용을 일으키고 값을 반환하지 않는다.
  - 명령을 대체하는 테스트 대역은 목이다.
- 조회 : 부작용을 일으키지 않고, 값을 반환한다.
  - 조회를 대체하는 테스트 대역은 스텁이다.

CQS (Command Query Seperation)



# 2 식별할 수 있는 동작과 구현 세부 사항

## 1 식별할 수 있는 동작은 공개 API 와 다르다.

- 잘 설계된 코드는 식별할 수 있는 동작이 공개 API아 일치하고, 구현 세부사항이 비공개 API 뒤에 숨겨져 있는 코드다.



## 3 잘 설계된 API 와 캡슐화

- 구현 세부사항을 숨기면 클라이언트에서 내부를 가릴 수 있으므로 내부를 손상시킬 위험이 적다.
- 데이터와 연산을 결합하면, 해당 연산이 클래스의 불변성을 위반하지 않도록할 수 있다.





# 3 목과 테스트 취약성 관계

## 1 육각형 아키텍처 정의

- 도메인 계층 (비즈니스 로직) 과 애플리케이션 서비스 계층 간 관심사 분리
- 애플리케이션 내부 통신
- 애플리케이션 간 통신



- 어떤 테스트든 비즈니스 요구 사항으로 거슬러 올라갈 수 있어야 한다.



## 2 시스템 내부 통신과 시스템 간 통신



# 4 단위 테스트의 고전파와 런던파 재고

- 고전파 선호
- 런던파를 따라 목을 무분별하게 사용하면, 종종 세부 사항에 결합돼 테스트에 리팩토링 내성이 없게 된다.
- 고전파는 테스트 간 공유하는 의존성만 교체하므로 유리하다. 시스템 간 통신에 대한 처리는 이상적이지는 않다. 런던파 만큼은 아니지만, 고전파도 목 사용을 장려한다.



## 1 모든 프로세스 외부 의존성을 목으로 해야 하는 것은 아니다

- 공유 의존성
- 프로세스 외부 의존성
- 비공개 의존성



고전파에서는 공유 의존성을 피할 것을 권고한다. 테스트가 실행 컨텍스트를 서로 방해하고, 결국 병렬로 처리할 수 없기 때문

- 테스트를 병렬적, 순차적 또는 임의의 순숴로 실행할 수 있는 것을 테스트 격리라 한다.
- 프로세스 외부 의존성이 애플리케이션을 통해서만 접근할 수 있다면, 이러한 의존성과의 통신은 시스템에서 식별할 수 있는 동작이 아니다.





## 2 목을 사용한 동작 검증

- 목은 애플리케이션 경계를 넘나드는 상호 작용을 검증할 때, 상호작용의 부작용이 외부환경에서 보일 때만 동작과 관련이 있다.









