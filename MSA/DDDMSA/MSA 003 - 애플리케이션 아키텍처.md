# MSA 003 - 애플리케이션 아키텍처

# 1 관심사 분리

- 애플리케이션 유지보수성이 높다 → 어느 누구든 손쉽게 애플리케이션을 이해하고 유지보수할 수 있다.

## 데이터베이스 중심 아키텍처 문제

- SQL 은 비즈니스 로직 처리를 위한 언어가 아니라, 데이터 처리에 최적화된 언어다.
- 스토리지가 비싸고, 한정적 인프라 상황에서 최적의 성능을 발휘하기위해 DB 중심 아키텍처가 필요했던 시기가 있었지만
- 클라우드 시대에는 필요한 만큼 인프라를 유연하게 이용할 수 있고, 저장 기술 또한 선택지가 다양하다.
  - 웹, 모바일, 명령형 인터페이스(CLI), IoT 기기 등 여러 디바이스 입출력 지원
  - RDB, Memory DB, NoSQL
  - Message queue
- 클라우드의 풍부한 자원환경에서는 애플리케이션 성능 자체보다는 애플리케이션 확장성, 유연함이 더 중요하다.

## Hexagonal 아키텍처와 클린 아키텍처

### 1 레이어드 아키텍처

애플리케이션이 내부에서 처리하는 관심사를 논리적으로 구분한다.

- 프리젠테이션
- 비즈니스 로직
- 데이터 액세스

![](https://i.ibb.co/x3ndWW6/image.png)

- 상위 계층이 하위 계층을 호출하는 단방향성 유지
- 상위 계층은 바로 밑의 근접 계층만 활용
- 상위 계층이 하위 계층에 영향을 받지 않게 구성
- 하위 계층은 자신을 사용하는 상위 계층을 알지 못하게 구성
- 계층 간 호출은 인터페이스 호출 (구현 클래스에 의존하지 않고, 약한 결합 유지)
  - 다형성 추구하여 제어 흐름을 간접적 전환
  - DIP 만족
  - 하지만 OCP 를 만족하지 않음
    - 소프트웨어 개체는 확장에 열려 있어야 하고, 변경에 닫혀있어야 한다.
    - 개체의 행위는 확장할 수 있어야 하지만, 개체를 변경해서는 안된다.
  - 예) 비즈니스 로직 계층에서 정의된 인터페이스.
    - 인터페이스가 바뀌면 비즈니스 계층도 영향이 생긴다.
    - 문제는 데이터 액세스 인터페이스 위치
    - 의존성 역전 원칙 적용(DIP) : 데이터 액세스 계층에서 정의한 인터페이스를 비즈니스 로직 계층으로 옮긴다.
    - 데이터 액세스 계층의 구현체는 비즈니스 로직 계층의 인터페이스를 바라본다.
    - 고수준영역(비즈니스 로직계층)이 저수준 영역(데이터 액세스계층)의 변경에 영향 받지 않게됨 → OCP 만족

![](https://i.ibb.co/k52MgJP/image.png)

<br />

### 2 헥사고날 아키텍처

- ports and adapters architecture 라고도 부른다.
- 여러 계층이 존재할 수 있는 경우 다양한 인터페이스가 필요
- 내부 영역은 순수 비즈니스 로직 표현
- 외부 영역은 외부에서 들어오는 요청을 처리하는 인바운드 어댑터 + 비즈니로직에 의해 호출되어 외부와 연계되는 아웃바운드 어댑터
- 고수준의 내부영역이 외부의 구체 어댑터에 의존하지 않음

![](https://i.ibb.co/cCtFtHM/image.png)

### 3 클린 아키텍처

![](https://i.ibb.co/K5N9SJm/image.png)

- 로버트 C. 마틴. 헥사고날 아이디어와 비슷
- 업무 규칙 : 사업적으로 수익을 얻거나 비용을 줄일 수 있는 규칙, 절차
- 엔티티 : 핵심 업무 규칙과 데이터는 본질적으로 결합돼있으므로 객체로 쉽게 만들 수 있다.
- 유스케이스 : 자동화된 시스템을 사용하는 처리 절차. 애플리케이션 특화된 업무 규칙
- 세부 사항 : 유스케이스를 감싼 나머지 : 입출력장치, 저장소, 웹시스템, 서버, 프레임워크, 통신 프로토콜
  - 세부사항과 유스케이스의 관계를 의존관계역전 원칙을 이용해 플러그인처럼 유연하게 처리한다.
  - 결합도를 낮춰 테스트 용이성, 개발/배포 독립성 강화



## 마이크로서비스의 내부 구조 정의

### 1 클린 마이크로서비스

![](https://i.ibb.co/QCf4DxV/image.png)

- 내부 영역에서는 맨 안쪽에 도메인이 존재. 도메인에 핵심 비즈니스, 개념, 규칙 구현
- 서비스에서 도메인을 호출해 업무를 처리하는 절차 기술
  - 외부 영역과 연계하기 위해 서비스 인터페이스 보유
  - 외부에서 내부 영역 사용할 수 있도록 API 제공하고 서비스가 이를 구현
- 내부 영역에 또 다른 인터페이스
  - 저장소 처리 인터페이스
    - 외부 영역이 아닌 내부 영역에 정의
    - 외부 영역 저장소 어댑터는 리포지토리 인터페이스를 각 저장소에 맞는 저장소 처리 세부 기술로 구현
- 외부 영역에는 다양한 인바운드, 아웃바운드 처리하는 어댑터가 위치
  - REST API 처리 어댑터
  - 이벤트 메시지 처리 어댑터
  - 메시지 구독하는 메시지 컨슈머 어댑터
  - 다른 마이크로서비스 API 호출하는 프록시 어댑터
  - 아웃바운드 어댑터는 DIP를 통해 외부 영역에서 내부 영역에 의존하도록 설계

### 2 내부 영역 - 업무규칙

- 서비스 인터페이스
  - 캡슐화 효과, 정보 은닉 효과
  - 클라이언트 사용 편의성 증가
    - 개발을 병렬적으로
    - 구현체가 다 개발되지 않아도 목 객체 생성해서 테스트 가능

#### 트랜잭션 스크립트 패턴

- Transaction Script Pattern
- 기능을 수행하는 책임이 서비스에게 있다. 서비스가 비대해진다.
- 서비스는 유스케이스 처리 단위이고, 비슷한 유스케이스의 경우 중복코드 발생한다.
- 유지보수 어렵다.

#### 도메인 모델 패턴

- Domain model pattern
- 도메인 객체가 데이터뿐 아니라 비즈니스 행위도 가진다.
- 서비스는 비즈니스 유스케이스를 구현하기 위해 도메인 객체에 일부 위임해서 처리한다.
  - 도메인 모델은 객체지향 설계의 객체 모델이다.
  - 이해, 관리, 테스트 쉽다.
  - 도메인 주도 설계의 애그리거트 패턴 적용할 수 있는 구조다.

#### 도메인주도설계의 애그리거트 패턴

- Domain Driven Desgin - Aggregate Pattern
- 객체 간 관계 복잡해질 경우 사용
- 최상위 엔티티 (Root Entity) 중심으로 개념 집합 분리
  - 애그리거트는 개념적으로 묶인 엔티티 모음 전체
  - 애그리거트를 한 단위로 일관되게 처리
    - 애그리거트 루트만 참조
    - 참조시 객체를 직접 참조하는 대신 기본 키를 사용한다. (느슨한 결합, 수정이 필요하지 않는 애그리거트 수정을 함께하는 실수 방지)
    - 하나의 트랜잭션으로 하나의 애그리거트만 생성/수정

![](https://i.ibb.co/S3M9JcR/image.png)

### 3 외부영역 - 세부사항

- 인바운드 어댑터
- 아웃바운드 어댑터
- 어댑터는 플러그인처럼 언제든지 교체되거나 확장 가능
- 주로 동기/비동기 통신, 저장소 처리

#### API 퍼블리싱 어댑터

- REST API 발행하는 인바운드 어댑터
- API 필요에 맞는 DTO 로 데이터 전달

#### API 프록시 어댑터

- 외부 API를 호출하는 아웃바운드 어댑터
- REST API, Socket, SOAP 등 적절한 통신

#### 저장소 처리 어댑터

- ORM 방식 : 도메인 모델 패턴 사용시 (비즈니스 복잡한 경우)
  - JPA, Spring Data
  - 런타임시 자동으로 쿼리 생성, 생산성 향상
- SQL 매핑 방식 : 트랜잭션 스크립트 패턴 사용시 (비즈니스 단순한 경우)
  - Mybatis

#### 도메인 이벤트 발행 어댑터

- 비동기 메시지 통신시 전달 정보가 ‘도메인 이벤트’
- ‘주문됨’, ‘주문취소됨’ 등의 명칭을 갖는 클래스
- 도메인 이벤트는 주로 내부영역에서 생성되고, 도메인 이벤트 발행 어댑터는 내부 영역의 이벤트 인터페이스를 구현해서 아웃바운드로 특정 메시지 큐나 스트림 저장소에 발행한다.

#### 도메인 이벤트 핸들러

- 이벤트 수신 인바운드 어댑터
- 외부에서 발행된 도메인 이벤트를 구독해서 내부 영역으로 전달









