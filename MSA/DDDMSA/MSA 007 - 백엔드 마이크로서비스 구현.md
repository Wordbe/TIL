# MSA 007 -  백엔드 마이크로서비스 구현



# 1 도서 대출

- 구현기능
- 내부 아키텍처
  - 도서 대출 서비스 - 헥사고날 아키텍처
  - 저장소 - ORM
  - 동기 통신 - Feign
  - 비동기 통신 - Kafka
- API 설계
- 도메인 모델링
  - 데이터 모델링에 익숙한 사람들은 비즈니스를 테이블화하고 정규화하려고 한다.
  - 그러면 특정 DB 에 의존하고 개발자 외의 사람들이 이해하기 어려워진다.
  - 도메인 모델링 목적은 누구라도 쉽게 이해하는 객체 모델을 만드는 것이다.

![](https://i.ibb.co/kQg59RN/image.png)

- 유스케이스 흐름
  - 시퀀스 다이어그램



### 내부 영역 - 도메인 모델 개발 (도서 대출, 반납)

### 내부 영역 - 서비스 개발

### 외부 영역 - REST 컨트롤러 개발

### 외부 영역 - 아웃바운드 어댑터 개발 (동기 호출)

- 타 서비스 동기 호출 : Feign 클라이언트 연결
  - REST 기반 동기 서비스 호출을 추상화한 Spring Cloud Netflix 라이브러리
  - 인터페이스만 작성하면 구체적인 HTTP 통신 구체 클라이언트를 생성해주고 스프링 런타임에 구현체를 제공한다.
  - feign 및 hystrix(분산 트레이싱) 설정
- EnableFeignClients 처리 - 메인 위에

### 외부 영역 - 아웃바운드 어댑터 개발 (비동기 호출 EDA 구현)

- 타 서비스 비동기 호출 처리 : Kafka 통한 EDA(이벤트 기반 아키텍처) 구현
  - 도서 마이크로서비스의 도서상태 변경
  - 포인트적립
  - 도서 카탈로그 마이크로서비스의 도서 상태변경

![](https://i.ibb.co/gZ94490/image.png)

- 도메인 이벤트 객체
- 도서 마이크로서비스 컨슈머(Consumer) 어댑터 구현하기
  - 대출 발생하면, 대출 마이크로서비스의 서비스 구현체인 `RentalServiceImpl` 에서 아웃바운드 어댑터 인터페이스인 `RentalProducer` 를 호출하고, `RentalProducer` 어댑터의 구현체인 `RentalKafkaProducerImpl` 이 `StockChanged` 도메인 이벤트를 발행한다.
  - 도서 마이크로서비스에서는 구독하고 있던 `BookKafkaConsumer` 에서 해당 이벤트를 받아 내부의 `BookService` 를 호출해서 도서 대출 상태를 변경해 비즈니스 일관성을 맞춘다.


![](https://i.ibb.co/MD9NjB0/image.png)

### 내부 영역 - 도메인 모델 개발 : 도서 연체 및 연체된 도서 반납

- 연체 처리
- 연체 반납 처리
- 대출 불가 처리

### 내부 영역 - 도메인 모델 개발: 대출 불가 해제 처리 기능 구현

### 외부영역 - REST 컨트롤러 개발

<br />

# 2 사용자 마이크로서비스 개발

- 기능 소개
- API 설계
- 도메인 모델링
- 유스케이스 흐름

### 내부영역 - 도메인 모델 개발, 서비스 개발, 레포지토리 개발

### 외부영역 - REST 컨트롤러 개발

- 개인정보관리
- 관리자용 회원정보관리

### 외부영역 - 아웃바운드 어댑터 개발

- `UserService` 에서 사용자를 생성, 저장하고 아웃바운드 어탭터 인터페이스(`gatewayProducer.createRental`)를 호출해서 대출 마이크로서비스에서 `Rental` 을 생성하도록 비동기 메시지 이벤트를 전송한다.
- `UserIdCreated` 라는 도메인 이벤트 발행, 대출 서비스가 구독중인 Topic에 카프카 메시지를 전송한다.

<br />

# 사용자 마이크로 서비스 - 포인트 관리 기능 구현

## 1 최초 기본 포인트 부여

## 2 포인트 적립/결제

## 3 포인트 적립, 결제 기능에 대한 호출구현

- 사용자 마이크로서비스는 컨슈머 어댑터인 `GatewayConsumer` 를 통해 포인트 적립 이벤트 메시지에 반응해야 한다.







