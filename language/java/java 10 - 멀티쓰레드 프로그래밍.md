# java 10 - 멀티쓰레드 프로그래밍



- Thread 클래스와 Runnable 인터페이스
- 쓰레드의 상태
- 쓰레드의 우선순위
- Main 쓰레드
- 동기화
- 데드락



## 프로세스 vs 쓰레드



| 항목           | 프로세스                                                   | 쓰레드                                                 |
| -------------- | ---------------------------------------------------------- | ------------------------------------------------------ |
| 자원 할당      | 실행 시마다 새로운 자원 할당                               | 자신을 실행한 프로세스의 자원을 공유                   |
| 자원 공유      | 일반적으로 공유하지 않는다. 한 프로그램 내에서 코드는 공유 | 한 프로세스 내에서 스택을 제외한 나머지 세 영역을 공유 |
| 독립성         | 독립적이다.                                                | 프로세스의 하위 집합이다.                              |
| 주소 소유      | 별개의 주소 공간을 갖는다.                                 | 주소 공간을 공유한다.                                  |
| 통신           | 운영체제가 제공하는 IPC 방법으로 통신한다.                 | 공유 변수 수정 등 자유롭게 다른 쓰레드와 소통한다.     |
| Context Swtich | 일반적으로 느리다.                                         | 일반적으로 빠르다.                                     |





### 1. 프로그램

실행가능한 명령어(instruction)의 집합, 디스크에 저장된 컴파일된 바이너리 이미지형태 또는 파이썬 스크립트 같이 해석되는(interpret) 고급어 형태일 수도 있다. 

> **인터프리터 언어**
>
> 원시코드(프로그래머가 작성한 소스코드)를 기계어로 변환하는 과정없이 한줄 한줄 해석하여 발 명령어를 실행하는 언어
>
> 예) R, Python, Ruby
>
> 기계어로 변환하지 않으므로 별도의 빌드 시간이 없다. Runtime 상황에서 한 줄씩 실시간으로 읽어 실행하므로 컴파일 언어에 비해 속도가 느리다. 하지만 코드 변경시 빌드 과정없이 실행이 가능하다. → 소스코드를 고치고 서버를 재실행하지 않아도 변경사항이 반영된 상태로 테스트를 진행할 수 있다.
>
> **빌드 과정이란?**
>
> 소스파일을 실행파일로 만드는 과정이다. 고급언어가 변환되어 저급언어(기계어)로 바뀌며 실행파일을 생성한다.

### 2. 프로세스

메모리에 적재(load)되어 실행되고 있는 프로그램을 말한다. '프로그램의 인스턴스'라고 불린다. 즉, 한 프로그램에서 실행되는 여러 프로세스가 존재할 수 있다.

프로세스는 커널에 의해 직접 관리된다. 커널 메모리 안에는 각 프로세스를 관리하는 데이터가 들어있다. 이 데이터는 PCB(Process Control Block) 자료구조 안에 있으며 프로세스를 제어하는 데 필요한 정보들이다.

PCB 는 아래 정보를 포함한다.

* 프로그램과 관련된 실행가능한 기계어 이미지
* 운영체제 관련되어 할당된 자원의 식별자 (UNIX - File Descriptor, Windows - Handle)
* 프로세스 permission 정보 (프로세스 소유자, 소유그룹, 그 외 등)
* `Context` (프로세스 상태) : 물리적 메모리 주소나 CPU 내 레지스터의 내용, 실행 중인 명령어를 지정하는 PC(Program Counter) 등을 포함한다.
* 실행되는 프로세스에 대한 메모리 주소

유저가 사용하는 메모리 공간 상의 프로세스 정보는 4가지로 분류된다. 커널 메모리 안에서 관리되는 PCB 정보와는 다르다.

* `Code`(text) : 프로그램의 실제 코드 저장
* `Data` : 프로세스가 실행될 때 정의된 전역 변수, static 변수
* `Heap` : 프로세스 런타임 중 동적으로 할당되는 변수들 저장
* `Stack` : 함수에서 다른 함수를 실행하는 등 서브루틴들의 정보를 저장

한 프로그램의 여러 프로세스 들은 코드영역을 공유한다. 하지만, 그 외 다른 자원을 겹쳐서 사용하지 않는다. 필요한 경우 프로세스 간 소통(IPC, Inter Process Communication) 을 제공한다.

> **멀티태스킹(Multitasking)**
>
> 한 컴퓨터에서 여러 가지 작업을 동시에 하는 것. 사실 프로세스들은 동시에 실행되고 있지 않지만 `Time Sharing` 기법을 통해 한 프로세스는 동시라고 느껴질만큼 매우 짧은 순간 동안 작업(CPU 점유)한 후 다른 프로세스에게 CPU 자원을 양보한다.
>
> **컨텍스트스위칭(Context Switching)**
>
> 프로세스가 전환되면서 context를 전환하는 것. 프로세스가 작업을 중단했을 때 context 정보는 프로세스가 전환될 때 PCB에 저장된다. 이후 자신의 차례가 오면 PCB 에서 저장된 상태를 가져와서 작업을 재개한다.
>
> 작업 중이던 context를 저장하고, 새로운 context 를 로드하면서 CPU 레지스터 상태 변환, 스택 포인터 추적, 명령어 추적하는 program counter에 대한 작업을 처리하기 때문에 오버헤드가 발생한다. 운영체제는 context switch 를 최적화한다.

<br />

### 3. 쓰레드

프로세스 내에서 실행되는 흐름

순차적 방식의 단점은 한 작업이 오래 걸리면 전체 프로그램이 지연되는 병목현상이 생길 수 있다는 점이다. 멀티쓰레드를 사용하면 순서에 의존하지 않는 작업을 병렬적으로 실행시켜 작업시간을 단축시킬 수 있다.

한 프로세스 안의 쓰레드들은 스택 공간을 제외한 나머지 공간과 시스템 자원을 공유한다.

쓰레드 장점

* 프로세스 간 통신에 비해 통신이 훨씬 간단하다. 공유변수만 변경하면 된다.
* 시스템 자원 소모가 줄어든다. 기존 프로세스 자원을 다른 쓰레드와 공유하기 때문에 자원을 새로 할당하지 않아도 된다.
* 전체 응답시간이 단축된다.

그래서 웹 서버가 각각의 HTTP 통신을 멀티쓰레드로 구현한다.

쓰레드 단점

* 멀티쓰레드 환경의 경우 프로그램 설계가 까다롭다. 디버깅이 어렵다.



